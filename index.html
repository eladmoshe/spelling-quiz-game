<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Quiz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background: #f3f4f6;
            min-height: 100vh;
            padding: 1rem;
        }

        #app {
            max-width: 42rem;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 500;
            color: #1f2937;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            width: 100%;
            padding: 0.75rem;
            font-size: 1.125rem;
        }

        .btn-outline {
            border: 1px solid #e5e7eb;
            background-color: white;
            color: #1f2937;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .lang-toggle {
            min-width: 100px;
            text-align: center;
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .celebration {
            animation: celebrate 0.5s ease-in-out;
        }
        
        .success-feedback {
            color: #059669;
            font-weight: bold;
            text-align: center;
            margin-top: 1rem;
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border-radius: 50%;
            pointer-events: none;
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        import WordMatcher from './dist/wordMatcher.js';
        import { translations } from './dist/translations.js';
        
        class SpellingGame {
            constructor() {
                this.wordList = [];
                this.currentIndex = 0;
                this.showPractice = false;
                this.attempts = {};
                this.currentWordCorrect = false;
                this.language = localStorage.getItem('spellingQuizLanguage') || 'en';
                
                this.app = document.getElementById('app');
                this.wordMatcher = new WordMatcher();
                this.render();
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            pronounceWord(word) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.rate = 0.5;
                utterance.pitch = 1;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }

            handleStart() {
                const input = document.querySelector('#wordInput');
                const words = input.value.split(',').map(word => word.trim()).filter(word => word);
                if (words.length > 0) {
                    this.wordList = this.shuffleArray(words);
                    this.currentIndex = 0;
                    this.attempts = {};  
                    this.showPractice = true;
                    this.pronounceWord(this.wordList[0]);
                    this.render();
                }
            }

            getNextLetterHint(userAnswer) {
                const currentWord = this.wordList[this.currentIndex];
                const hint = this.wordMatcher.getHint(userAnswer, currentWord);
                const firstUnderscoreIndex = hint.indexOf('_');
                
                if (firstUnderscoreIndex === -1) {
                    return {
                        correct: true,
                        message: 'Correct!',
                        progress: hint
                    };
                }
                
                return {
                    correct: false,
                    message: `Check letter #${firstUnderscoreIndex + 1}. Should be: "${currentWord[firstUnderscoreIndex]}"`,
                    progress: hint
                };
            }

            getWordPatterns(word) {
                let html = '<div class="space-y-2"><p class="text-2xl font-mono tracking-wide text-center">';
                
                for (let i = 0; i < word.length; i++) {
                    const char = word[i];
                    // Check for consonant blends
                    const blends = ['bl','br','ch','cl','cr','dr','fl','fr','gl','gr','pl','pr','sc','sh','sk','sl','sm','sn','sp','st','sw','th','tr','tw','wh'];
                    let isBlend = false;
                    for (let blend of blends) {
                        if (word.slice(i, i + 2).toLowerCase() === blend) {
                            html += `<span class="text-indigo-600 font-bold">${word.slice(i, i + 2)}</span>`;
                            i++;
                            isBlend = true;
                            break;
                        }
                    }
                    if (isBlend) continue;

                    // Check for vowel pairs
                    if ('aeiou'.includes(word[i].toLowerCase()) && 'aeiou'.includes(word[i + 1]?.toLowerCase())) {
                        html += `<span class="text-amber-600 font-bold">${word.slice(i, i + 2)}</span>`;
                        i++;
                        continue;
                    }

                    // Check for doubled letters
                    if (word[i].toLowerCase() === word[i + 1]?.toLowerCase()) {
                        html += `<span class="text-teal-600 font-bold">${word.slice(i, i + 2)}</span>`;
                        i++;
                        continue;
                    }

                    // Individual vowels
                    if ('aeiou'.includes(word[i].toLowerCase())) {
                        html += `<span class="text-orange-600">${char}</span>`;
                    } else {
                        html += `<span class="text-gray-700">${char}</span>`;
                    }
                }

                html += `</p>
                    <div class="text-sm space-y-1">
                        <p><span class="text-indigo-600 font-bold">Indigo</span>: Consonant blends (like 'sh', 'th')</p>
                        <p><span class="text-amber-600 font-bold">Amber</span>: Vowel pairs</p>
                        <p><span class="text-teal-600 font-bold">Teal</span>: Double letters</p>
                        <p><span class="text-orange-600">Orange</span>: Single vowels</p>
                    </div></div>`;
                return html;
            }

            compareWords(userAnswer, correctWord) {
                return this.wordMatcher.compareWords(userAnswer, correctWord);
            }

            findNextMatch(userSlice, correctSlice) {
                return this.wordMatcher.findNextMatch(userSlice, correctSlice);
            }

            checkAnswer() {
                const input = document.querySelector('#answerInput');
                const userAnswer = input.value.trim().toLowerCase();
                const currentWord = this.wordList[this.currentIndex].toLowerCase();
                
                // Don't accept empty answers
                if (!userAnswer) {
                    return;
                }
                
                if (userAnswer === currentWord) {
                    this.currentWordCorrect = true;
                    
                    // Add celebration effects
                    const app = document.querySelector('#app');
                    app.querySelector('.card').classList.add('celebration');
                    
                    // Create confetti effect
                    for (let i = 0; i < 30; i++) {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                        confetti.style.backgroundColor = ['#3b82f6', '#059669', '#fbbf24'][Math.floor(Math.random() * 3)];
                        confetti.style.animation = `confetti ${1 + Math.random() * 2}s linear forwards`;
                        document.body.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }
                    
                    // Play the word again after a short delay
                    setTimeout(() => this.pronounceWord(currentWord), 1000);
                    
                    this.render();
                    return;
                }
                
                const result = this.wordMatcher.checkWord(userAnswer, currentWord);
                
                if (!this.attempts[this.currentIndex]) {
                    this.attempts[this.currentIndex] = 1;
                } else {
                    this.attempts[this.currentIndex]++;
                }

                let comparisonHtml = '';
                let errorMessage = '';

                // Generate the visual comparison
                const chars = userAnswer.split('');
                chars.forEach((char, i) => {
                    if (!result.isCorrect && i >= result.firstWrongLetter) {
                        if (i === result.firstWrongLetter) {
                            comparisonHtml += `<span class="text-red-500">${char}</span>`;
                            errorMessage = `${this.t('checkLetter')} #${i + 1}`;
                        } else {
                            comparisonHtml += `<span class="text-gray-400">${char}</span>`;
                        }
                    } else {
                        comparisonHtml += char;
                    }
                });

                const resultDiv = document.querySelector('#result');
                resultDiv.innerHTML = `
                    <div class="mt-4 p-4 bg-red-50 rounded-lg">
                        <p class="text-xl font-mono tracking-wide text-center">${comparisonHtml}</p>
                        <p class="text-sm font-medium text-red-800 text-center mt-2">${errorMessage}</p>
                    </div>
                `;
            }

            showError(userAnswer) {
                const currentWord = this.wordList[this.currentIndex];
                const result = this.wordMatcher.checkWord(userAnswer, currentWord);
                
                if (!this.attempts[this.currentIndex]) {
                    this.attempts[this.currentIndex] = 1;
                } else {
                    this.attempts[this.currentIndex]++;
                }

                let errorMessage = '';

                // Find the first error
                if (!result.isCorrect) {
                    const pos = result.firstWrongLetter;
                    errorMessage = `Extra or incorrect letter: "${userAnswer[pos]}"`;
                }

                const resultDiv = document.querySelector('#result');
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-red-800">${errorMessage}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-800 mb-2">
                                Need help? Here's a pattern breakdown to help you remember:
                            </p>
                            ${this.getWordPatterns(currentWord)}
                        </div>
                    </div>
                `;
            }

            showSuccess() {
                const resultDiv = document.querySelector('#result');
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-center gap-2 text-green-500">
                            <span class="text-lg font-medium">Excellent job!</span>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-green-800 mb-2">
                                Let's break down this word to help you remember it:
                            </p>
                            ${this.getWordPatterns(this.wordList[this.currentIndex])}
                        </div>
                        ${this.currentIndex < this.wordList.length - 1 ? `
                            <button onclick="game.nextWord()" class="btn btn-primary w-full">
                                Next Word ➡️
                            </button>
                        ` : `
                            <div class="text-center">
                                <p class="text-lg font-medium text-green-500 mb-4">
                                    Congratulations! You've completed all words! 🎉
                                </p>
                                <button onclick="game.reset()" class="btn btn-primary">
                                    Practice New Words
                                </button>
                            </div>
                        `}
                    </div>
                `;
                setTimeout(() => this.pronounceWord(this.wordList[this.currentIndex]), 500);
            }

            nextWord() {
                if (this.currentIndex < this.wordList.length - 1) {
                    this.currentIndex++;
                    this.currentWordCorrect = false;  
                    this.render();
                    setTimeout(() => this.pronounceWord(this.wordList[this.currentIndex]), 500);
                } else {
                    this.reset();
                }
            }

            reset() {
                this.wordList = [];
                this.currentIndex = 0;
                this.showPractice = false;
                this.render();
            }

            t(key) {
                const keys = key.split('.');
                let value = translations[this.language];
                for (const k of keys) {
                    value = value[k];
                }
                return value;
            }

            toggleLanguage() {
                this.language = this.language === 'en' ? 'he' : 'en';
                localStorage.setItem('spellingQuizLanguage', this.language);
                this.render();
            }

            render() {
                if (!this.showPractice) {
                    this.app.innerHTML = `
                        <div class="card">
                            <div class="header-container">
                                <h1 class="title">${this.t('enterWords')}</h1>
                                <button onclick="game.toggleLanguage()" class="btn btn-outline lang-toggle">
                                    ${this.t('switchToHebrew')}
                                </button>
                            </div>
                            <input type="text" id="wordInput" class="input" />
                            <button onclick="game.handleStart()" class="btn btn-primary">
                                ${this.t('start')}
                            </button>
                        </div>
                    `;
                } else {
                    const currentWord = this.wordList[this.currentIndex];
                    const isLastWord = this.currentIndex === this.wordList.length - 1;
                    
                    if (this.currentWordCorrect && isLastWord) {
                        this.app.innerHTML = `
                            <div class="card">
                                <div class="header-container">
                                    <h1 class="title">${this.t('practiceComplete')}</h1>
                                    <button onclick="game.toggleLanguage()" class="btn btn-outline lang-toggle">
                                        ${this.t('switchToHebrew')}
                                    </button>
                                </div>
                                <button onclick="game.reset()" class="btn btn-primary">
                                    ${this.t('startOver')}
                                </button>
                            </div>
                        `;
                        return;
                    }

                    this.app.innerHTML = `
                        <div class="card">
                            <div class="header-container">
                                <h1 class="title">Word ${this.currentIndex + 1} of ${this.wordList.length}</h1>
                                <button onclick="game.toggleLanguage()" class="btn btn-outline lang-toggle">
                                    ${this.t('switchToHebrew')}
                                </button>
                            </div>
                            <div class="flex gap-4 mb-4">
                                <button onclick="game.pronounceWord('${currentWord}')" class="btn btn-outline flex-1">
                                    ${this.t('listen')}
                                </button>
                            </div>
                            <input type="text" id="answerInput" class="input" ${this.currentWordCorrect ? 'disabled' : ''} />
                            ${this.currentWordCorrect ? `
                                <div class="success-feedback">${this.t('correct')}</div>
                                ${!isLastWord ? `
                                    <button onclick="game.nextWord()" class="btn btn-primary">
                                        ${this.t('next')}
                                    </button>
                                ` : ''}
                            ` : `
                                <button onclick="game.checkAnswer()" class="btn btn-primary">
                                    ${this.t('check')}
                                </button>
                            `}
                            <div id="result"></div>
                            ${this.currentWordCorrect ? this.getWordPatterns(currentWord) : ''}
                        </div>
                    `;
                    
                    if (!this.currentWordCorrect) {
                        const input = document.querySelector('#answerInput');
                        input.focus();
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                game.checkAnswer();
                            }
                        });
                    }
                }
            }
        }

        // Create and initialize the game instance
        window.game = new SpellingGame();
    </script>
</body>
</html>