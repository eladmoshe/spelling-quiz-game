<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Quiz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-outline {
            border: 1px solid #e5e7eb;
            background-color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        .pattern-breakdown .consonant-blends { color: #4B0082; /* Bright Indigo */ }
        .pattern-breakdown .vowel-pairs { color: #FFA500; /* Bright Orange */ }
        .pattern-breakdown .double-letters { color: #008080; /* Bright Teal */ }
        .pattern-breakdown .single-vowels { color: #9400D3; /* Bright Purple */ }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div id="app" class="max-w-2xl mx-auto"></div>
    
    <script type="module">
        import WordMatcher from './js/wordMatcher.js';
        
        class SpellingGame {
            constructor() {
                this.wordList = [];
                this.currentIndex = 0;
                this.showPractice = false;
                this.attempts = {};  // Track attempts per word
                
                this.app = document.getElementById('app');
                this.wordMatcher = new WordMatcher();
                this.render();
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            pronounceWord(word) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.rate = 0.5;
                utterance.pitch = 1;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }

            handleStart() {
                const input = document.querySelector('#wordInput');
                const words = input.value.split(',').map(word => word.trim()).filter(word => word);
                if (words.length > 0) {
                    this.wordList = this.shuffleArray(words);
                    this.currentIndex = 0;
                    this.attempts = {};  // Reset attempts
                    this.showPractice = true;
                    this.pronounceWord(this.wordList[0]);
                    this.render();
                }
            }

            getNextLetterHint(userAnswer) {
                const currentWord = this.wordList[this.currentIndex];
                const hint = this.wordMatcher.getHint(userAnswer, currentWord);
                const firstUnderscoreIndex = hint.indexOf('_');
                
                if (firstUnderscoreIndex === -1) {
                    return {
                        correct: true,
                        message: 'Correct!',
                        progress: hint
                    };
                }
                
                return {
                    correct: false,
                    message: `Check letter #${firstUnderscoreIndex + 1}. Should be: "${currentWord[firstUnderscoreIndex]}"`,
                    progress: hint
                };
            }

            getWordPatterns(word) {
                let html = '<div class="space-y-2"><p class="text-2xl font-mono tracking-wide text-center">';
                
                for (let i = 0; i < word.length; i++) {
                    const char = word[i];
                    // Check for consonant blends
                    const blends = ['bl','br','ch','cl','cr','dr','fl','fr','gl','gr','pl','pr','sc','sh','sk','sl','sm','sn','sp','st','sw','th','tr','tw','wh'];
                    let isBlend = false;
                    for (let blend of blends) {
                        if (word.slice(i, i + 2).toLowerCase() === blend) {
                            html += `<span class="pattern-breakdown consonant-blends">${word.slice(i, i + 2)}</span>`;
                            i++;
                            isBlend = true;
                            break;
                        }
                    }
                    if (isBlend) continue;

                    // Check for vowel pairs
                    if ('aeiou'.includes(word[i].toLowerCase()) && 'aeiou'.includes(word[i + 1]?.toLowerCase())) {
                        html += `<span class="pattern-breakdown vowel-pairs">${word.slice(i, i + 2)}</span>`;
                        i++;
                        continue;
                    }

                    // Check for doubled letters
                    if (word[i].toLowerCase() === word[i + 1]?.toLowerCase()) {
                        html += `<span class="pattern-breakdown double-letters">${word.slice(i, i + 2)}</span>`;
                        i++;
                        continue;
                    }

                    // Individual vowels
                    if ('aeiou'.includes(word[i].toLowerCase())) {
                        html += `<span class="pattern-breakdown single-vowels">${char}</span>`;
                    } else {
                        html += `<span class="text-gray-700">${char}</span>`;
                    }
                }

                html += `</p>
                    <div class="text-sm space-y-1">
                        <p><span class="pattern-breakdown consonant-blends">Indigo</span>: Consonant blends (like 'sh', 'th')</p>
                        <p><span class="pattern-breakdown vowel-pairs">Amber</span>: Vowel pairs</p>
                        <p><span class="pattern-breakdown double-letters">Teal</span>: Double letters</p>
                        <p><span class="pattern-breakdown single-vowels">Purple</span>: Single vowels</p>
                    </div></div>`;
                return html;
            }

            compareWords(userAnswer, correctWord) {
                return this.wordMatcher.compareWords(userAnswer, correctWord);
            }

            findNextMatch(userSlice, correctSlice) {
                return this.wordMatcher.findNextMatch(userSlice, correctSlice);
            }

            checkAnswer() {
                const input = document.querySelector('#answerInput');
                const userAnswer = input.value;
                const currentWord = this.wordList[this.currentIndex];
                const hint = this.wordMatcher.getHint(userAnswer, currentWord);
                
                if (!this.attempts[this.currentIndex]) {
                    this.attempts[this.currentIndex] = 1;
                } else {
                    this.attempts[this.currentIndex]++;
                }

                let comparisonHtml = '';
                let errorMessage = '';

                // Generate the visual comparison
                let chars = hint.word.split('');
                chars.forEach((char, i) => {
                    if (hint.redLetterPositions.includes(i)) {
                        comparisonHtml += `<span class="text-red-500">${char}</span>`;
                        if (!errorMessage) {
                            errorMessage = `Extra or incorrect letter: "${char}"`;
                        }
                    } else if (hint.underscorePositions.includes(i)) {
                        comparisonHtml += `<span class="text-red-500">_</span>`;
                        if (!errorMessage) {
                            errorMessage = `Missing letter: "${currentWord[i]}"`;
                        }
                    } else {
                        comparisonHtml += `<span class="text-green-500">${char}</span>`;
                    }
                });

                // Add underscores for any remaining missing letters
                for (let i = chars.length; i < currentWord.length; i++) {
                    if (hint.underscorePositions.includes(i)) {
                        comparisonHtml += `<span class="text-red-500">_</span>`;
                        if (!errorMessage) {
                            errorMessage = `Missing letter: "${currentWord[i]}"`;
                        }
                    }
                }

                const showPatternBreakdown = this.attempts[this.currentIndex] >= 3;
                const resultDiv = document.querySelector('#result');
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-red-800 mb-2">Your answer:</p>
                            <p class="text-2xl font-mono tracking-wide">${comparisonHtml}</p>
                            <p class="text-sm font-medium text-red-800 mt-2">${errorMessage}</p>
                        </div>
                        ${showPatternBreakdown ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-800 mb-2">
                                    Need help? Here's a pattern breakdown to help you remember:
                                </p>
                                ${this.getWordPatterns(currentWord)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            showError(userAnswer) {
                const currentWord = this.wordList[this.currentIndex];
                const hint = this.wordMatcher.getHint(userAnswer, currentWord);
                
                if (!this.attempts[this.currentIndex]) {
                    this.attempts[this.currentIndex] = 1;
                } else {
                    this.attempts[this.currentIndex]++;
                }

                let errorMessage = '';

                // Find the first error
                if (hint.redLetterPositions.length > 0) {
                    const pos = hint.redLetterPositions[0];
                    errorMessage = `Extra or incorrect letter: "${userAnswer[pos]}"`;
                } else if (hint.underscorePositions.length > 0) {
                    const pos = hint.underscorePositions[0];
                    errorMessage = `Missing letter: "${currentWord[pos]}"`;
                }

                // Show error message and word patterns after 3 attempts
                const showPatternBreakdown = this.attempts[this.currentIndex] >= 3;
                const resultDiv = document.querySelector('#result');
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-red-800">${errorMessage}</p>
                        </div>
                        ${showPatternBreakdown ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm font-medium text-gray-800 mb-2">
                                    Need help? Here's a pattern breakdown to help you remember:
                                </p>
                                ${this.getWordPatterns(currentWord)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            showSuccess() {
                const resultDiv = document.querySelector('#result');
                resultDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-center gap-2 text-green-500">
                            <span class="text-lg font-medium">Excellent job!</span>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-green-800 mb-2">
                                Let's break down this word to help you remember it:
                            </p>
                            ${this.getWordPatterns(this.wordList[this.currentIndex])}
                        </div>
                        ${this.currentIndex < this.wordList.length - 1 ? `
                            <button onclick="game.nextWord()" class="btn btn-primary w-full">
                                Next Word
                            </button>
                        ` : `
                            <div class="text-center">
                                <p class="text-lg font-medium text-green-500 mb-4">
                                    Congratulations! You've completed all words! 🎉
                                </p>
                                <button onclick="game.reset()" class="btn btn-primary">
                                    Practice New Words
                                </button>
                            </div>
                        `}
                    </div>
                `;
                setTimeout(() => this.pronounceWord(this.wordList[this.currentIndex]), 500);
            }

            nextWord() {
                if (this.currentIndex < this.wordList.length - 1) {
                    this.currentIndex++;
                    this.render();
                    setTimeout(() => this.pronounceWord(this.wordList[this.currentIndex]), 500);
                } else {
                    this.reset();
                }
            }

            reset() {
                this.wordList = [];
                this.currentIndex = 0;
                this.showPractice = false;
                this.render();
            }

            render() {
                if (!this.showPractice) {
                    this.app.innerHTML = `
                        <div class="card">
                            <div class="p-6">
                                <div class="space-y-4">
                                    <h2 class="text-xl font-bold">Enter Words</h2>
                                    <input
                                        id="wordInput"
                                        class="input"
                                        placeholder="Enter words separated by commas"
                                    />
                                    <button onclick="game.handleStart()" class="btn btn-primary w-full">
                                        Start Practice
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    this.app.innerHTML = `
                        <div class="card">
                            <div class="p-6">
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <h2 class="text-xl font-bold">Spell the Word</h2>
                                        <button onclick="game.reset()" class="btn btn-outline">
                                            New Words
                                        </button>
                                    </div>
                                    
                                    <p class="text-center">Word ${this.currentIndex + 1} of ${this.wordList.length}</p>
                                    
                                    <button onclick="game.pronounceWord('${this.wordList[this.currentIndex]}')" class="btn btn-primary w-full">
                                        Listen to the word
                                    </button>

                                    <input
                                        id="answerInput"
                                        class="input text-lg text-center"
                                        placeholder="Type your answer"
                                        onkeypress="if(event.key === 'Enter') game.checkAnswer()"
                                    />

                                    <button onclick="game.checkAnswer()" class="btn btn-primary w-full">
                                        Check Answer
                                    </button>

                                    <div id="result"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Create and initialize the game instance
        window.game = new SpellingGame();
    </script>
</body>
</html>